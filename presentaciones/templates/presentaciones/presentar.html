{% extends 'presentaciones/base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body {
        background: transparent !important;
    }
    
    body .base-container {
        background: transparent !important;
    }
    
    body .main-content {
        padding: 0 !important;
        margin: 0 !important;
        background: transparent !important;
        min-height: auto !important;
    }
    
    body .main-content .presentar-container {
        min-height: calc(100vh - 80px);
        background: linear-gradient(to bottom, 
            #ffffff 0%, 
            #ffffff 50%, 
            #f5f0ff 60%,
            #ead9ff 75%,
            #A855F7 100%
        ) !important;
        padding: 2rem 1rem 3rem !important;
        width: 100% !important;
    }
    
    .presentar-content {
        max-width: 1400px;
        margin: 0 auto !important;
    }
    
    .presentar-card {
        background: white !important;
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.15);
    }
    
    .presentar-card .presentar-title {
        font-size: 2rem !important;
        font-weight: 700 !important;
        color: #1f2937 !important;
        text-align: center;
        margin: 0 0 1.5rem 0 !important;
    }

    .stop-presentation-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #f3f4f6;
    }

    .btn-stop-presentation {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7rem;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .btn-stop-presentation:hover {
        background: linear-gradient(135deg, #b91c1c, #991b1b);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
    }

    .btn-stop-presentation:active {
        transform: translateY(0);
    }

    .btn-stop-presentation:disabled {
        background: linear-gradient(135deg, #9ca3af, #6b7280);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-stop-presentation i {
        font-size: 1.2rem;
    }

    .btn-stop-presentation .fa-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    #fullscreen-btn {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    #fullscreen-btn:hover {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    #fullscreen-btn:active {
        transform: translateY(0);
    }

    #fullscreen-btn i {
        font-size: 1.1rem;
    }

    .buttons-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .pdf-container.fullscreen-mode {
        background: #1a1a1a !important;
        width: 100vw !important;
        height: 100vh !important;
        overflow: auto !important;
        position: relative !important;
        display: block !important;
    }

    .fullscreen-mode #canvas-container {
        width: max-content !important;
        height: max-content !important;
        min-width: 100% !important;
        min-height: 100% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        position: relative !important;
    }

    .fullscreen-mode #pdf-canvas {
        display: block !important;
        position: relative !important;
    }

    .fullscreen-mode #drawing-canvas {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        pointer-events: none !important;
    }

    .fullscreen-mode .status-indicator,
    .fullscreen-mode .drawing-mode-indicator,
    .fullscreen-mode .zoom-indicator {
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: fixed !important;
    }

    .fullscreen-mode .btn-nav-side {
        background: rgba(0, 0, 0, 0.7) !important;
        color: white !important;
        z-index: 100 !important;
        position: fixed !important;
    }

    .fullscreen-mode .btn-nav-prev {
        left: 20px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
    }

    .fullscreen-mode .btn-nav-next {
        right: 20px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
    }

    .fullscreen-mode .btn-nav-side:hover {
        background: rgba(0, 0, 0, 0.9) !important;
    }

    .fullscreen-mode #pointer-overlay {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        pointer-events: none !important;
    }

    .fullscreen-mode .btn-stop-presentation {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(220, 38, 38, 0.95);
        backdrop-filter: blur(10px);
    }

    .fullscreen-mode .btn-stop-presentation:hover {
        background: rgba(185, 28, 28, 1);
    }

    .fullscreen-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        display: none;
        z-index: 9999;
        pointer-events: none;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fullscreen-mode ~ .fullscreen-indicator {
        display: block;
    }

    @media (max-width: 768px) {
        #fullscreen-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-stop-presentation {
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
            width: 100%;
            max-width: none;
        }
        
        .buttons-section {
            flex-direction: column;
            align-items: stretch;
        }

        .stop-presentation-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
    }
</style>
<link rel="stylesheet" href="{% static 'css/presentar.css' %}">
{% endblock %}

{% block title %}Visor de Presentaci√≥n - {{ presentacion.titulo }}{% endblock %}

{% block content %}
<div class="presentar-container">
    <div class="presentar-content">
        <div class="presentar-card">
            <h1 class="presentar-title">
                {{ presentacion.titulo }}
            </h1>

            {% if detector_iniciado %}
            <div class="alert alert-success">
                <div class="alert-content">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <p class="alert-text">{{ mensaje_detector }}</p>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <div class="alert-content">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="alert-text">{{ mensaje_detector }}</p>
                </div>
            </div>
            {% endif %}

            <div class="controls-section">
                <div class="info-section">
                    <span id="page-info" class="page-info">Cargando PDF...</span>
                    <span id="zoom-info" class="zoom-info">Zoom: 100%</span>
                </div>

                <span id="last-command" class="last-command">√öltimo comando: ninguno</span>

                <div class="buttons-section">
                    <div class="zoom-buttons">
                        <button id="zoom-out" class="btn-zoom">-</button>
                        <button id="reset-zoom" class="btn-zoom btn-zoom-reset">Reset</button>
                        <button id="zoom-in" class="btn-zoom">+</button>
                    </div>
                    
                    <div class="drawing-controls" id="drawing-controls">
                        <button id="toggle-drawing" class="btn-drawing">Dibujo</button>
                        <button id="clear-drawings" class="btn-clear">Limpiar</button>
                    </div>

                    <button id="fullscreen-btn" title="Pantalla completa (F)">
                        <i class="fas fa-expand"></i>
                        <span>Pantalla Completa</span>
                    </button>
                </div>
            </div>

            <div class="pdf-viewer-wrapper">
                <button id="prev-page" class="btn-nav-side btn-nav-prev" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>

                <div id="pdf-container" class="pdf-container">
                    <div class="status-indicator" id="mode-indicator">NAVEGACI√ìN</div>
                    <div class="drawing-mode-indicator" id="drawing-mode-indicator">MODO DIBUJO: OFF</div>
                    <div class="zoom-indicator" id="zoom-indicator">100%</div>

                    <div id="canvas-container">
                        <canvas id="pdf-canvas"></canvas>
                        <canvas id="drawing-canvas"></canvas>
                        
                        <div id="pointer-overlay">
                            <div id="pointer-dot" class="pointer-dot" style="display: none;">
                                <div class="pointer-outer">
                                    <div class="pointer-inner"></div>
                                    <div class="pointer-crosshair-h"></div>
                                    <div class="pointer-crosshair-v"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="next-page" class="btn-nav-side btn-nav-next" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="stop-presentation-container">
                <button id="stop-presentation-btn" class="btn-stop-presentation" title="Detener presentaci√≥n y volver al inicio">
                    <i class="fas fa-stop-circle"></i>
                    <span>Detener Presentaci√≥n</span>
                </button>
            </div>

            <div class="gestures-guide">
                <h3 class="gestures-title">Controles de Gestos:</h3>
                <div class="gestures-grid">
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-purple">‚úåÔ∏è</span>
                        <span class="gesture-text"><strong>PAZ (√≠ndice+medio):</strong> Activar/desactivar modo dibujo</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-yellow">‚úä</span>
                        <span class="gesture-text"><strong>Pu√±o cerrado:</strong> Puntero activo</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-blue">ü§ò</span>
                        <span class="gesture-text"><strong>√çndice solo:</strong> Dibujar (modo dibujo)</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-orange">üñêÔ∏è</span>
                        <span class="gesture-text"><strong>Mano abierta:</strong> Borrar (modo dibujo)</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-purple">üëå</span>
                        <span class="gesture-text"><strong>Pinza (pulgar+√≠ndice):</strong> Mover dibujos (modo dibujo)</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-green">üëç</span>
                        <span class="gesture-text"><strong>Pulgar solo:</strong> Limpiar dibujos (modo dibujo)</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-red">üñêÔ∏èüñêÔ∏è</span>
                        <span class="gesture-text"><strong>Ambas manos abiertas:</strong> Zoom din√°mico</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-green">üëâ</span>
                        <span class="gesture-text"><strong>Pistola derecha:</strong> P√°gina siguiente</span>
                    </div>
                    <div class="gesture-item">
                        <span class="gesture-badge gesture-badge-green">üëà</span>
                        <span class="gesture-text"><strong>Pistola izquierda:</strong> P√°gina anterior</span>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                    <p style="margin: 0; color: #4b5563; font-size: 0.95rem;">
                        <strong style="color: #8b5cf6;">üí° Atajos de teclado:</strong> Presiona <kbd style="background: white; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-family: monospace;">F</kbd> para pantalla completa. <kbd style="background: white; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-family: monospace;">ESC</kbd> para salir.
                    </p>
                </div>
            </div>

            <div id="error-message" class="error-message" style="display: none;">
                <p>Error: No se pudo cargar el documento PDF.</p>
            </div>
        </div>
    </div>
</div>

<div class="fullscreen-indicator">
    Modo Pantalla Completa Activo - Presiona ESC para salir
</div>

<script>
    const PDF_URL = "{{ url_pdf }}";
    const COMANDO_GESTO_URL = "{% url 'presentaciones:comando_gesto' %}";
    const DETENER_DETECTOR_URL = "{% url 'presentaciones:detener_detector' %}";
    const HOME_URL = "{% url 'presentaciones:home' %}";
    
    {% if debug %}
    console.log('=== DEBUG INFO ===');
    console.log('PDF URL:', PDF_URL);
    console.log('Comando Gesto URL:', COMANDO_GESTO_URL);
    console.log('Detener Detector URL:', DETENER_DETECTOR_URL);
    console.log('Home URL:', HOME_URL);
    console.log('Presentaci√≥n ID:', {{ presentacion.id }});
    console.log('==================');
    {% endif %}
</script>
<script src="{% static 'js/presentar.js' %}"></script>
{% endblock %}